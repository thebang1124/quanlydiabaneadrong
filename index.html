<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Địa Bàn & Tài Khoản</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">Hệ Thống Quản Lý Địa Bàn</h1>
        <p class="text-center text-gray-600 mb-6">Quản lý các Thôn, Hộ và Thành viên.</p>

        <!-- Login and User Info Section -->
        <div id="auth-section" class="bg-blue-100 text-blue-800 rounded-lg p-3 mb-6 flex flex-col md:flex-row items-center justify-between space-y-2 md:space-y-0 md:space-x-4">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <div id="auth-status" class="text-sm font-medium">Đang xác thực...</div>
            </div>
            <div id="login-buttons" class="flex space-x-2">
                <button id="admin-login-btn" class="bg-blue-600 text-white font-semibold py-1 px-4 rounded-lg hover:bg-blue-700 transition-all duration-200">Đăng nhập Quản trị</button>
                <button id="cadre-login-btn" class="bg-indigo-600 text-white font-semibold py-1 px-4 rounded-lg hover:bg-indigo-700 transition-all duration-200">Đăng nhập Cán bộ</button>
            </div>
        </div>

        <!-- Main Content (Hidden until login) -->
        <div id="main-content" class="hidden">
            <!-- Navigation Breadcrumbs -->
            <nav class="flex items-center space-x-2 mb-4 text-sm font-medium text-gray-500">
                <a href="#" id="home-link" class="hover:text-blue-600">Thôn/Buôn</a>
                <span id="household-crumb" class="hidden">/ <a href="#" class="household-crumb-link hover:text-blue-600"></a></span>
                <span id="member-crumb" class="hidden">/ <span class="text-gray-700">Thành viên</span></span>
            </nav>

            <!-- Hamlet/Village List Section -->
            <div id="precinct-list-section">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Danh Sách Thôn/Buôn</h2>
                    <button id="add-precinct-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-200 hidden">
                        + Thêm Thôn/Buôn
                    </button>
                </div>
                <div id="precincts-list" class="space-y-4">
                    <p class="text-center text-gray-500">Đang tải danh sách...</p>
                </div>
            </div>

            <!-- Household List Section -->
            <div id="household-list-section" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 id="household-list-title" class="text-2xl font-semibold text-gray-700"></h2>
                    <button id="add-household-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-200 hidden">
                        + Thêm Hộ gia đình
                    </button>
                </div>
                <div id="households-list" class="space-y-4">
                    <p class="text-center text-gray-500">Đang tải danh sách...</p>
                </div>
            </div>

            <!-- Member List Section -->
            <div id="member-list-section" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 id="member-list-title" class="text-2xl font-semibold text-gray-700"></h2>
                    <button id="add-member-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-200 hidden">
                        + Thêm Thành viên
                    </button>
                </div>
                <div id="members-list" class="space-y-4">
                    <p class="text-center text-gray-500">Đang tải danh sách...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Forms and Messages -->
    <div id="modal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-center"></h3>
            <div id="modal-content-area">
                <!-- Forms will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Cấu hình và Khởi tạo Firebase ---
        let app, db, auth;
        let userId = null;
        let isAdmin = false;

        const ADMIN_ID = "admin12345";
        
        setLogLevel('debug');

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                const authStatusEl = document.getElementById('auth-status');
                const loginButtons = document.getElementById('login-buttons');
                const mainContent = document.getElementById('main-content');
                
                if (user) {
                    userId = user.uid;
                    loginButtons.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    
                    if (userId === ADMIN_ID) {
                        isAdmin = true;
                        authStatusEl.innerHTML = 'Đã đăng nhập với vai trò **Quản trị viên**';
                        uiElements.addPrecinctBtn.classList.remove('hidden');
                        uiElements.addHouseholdBtn.classList.remove('hidden');
                        uiElements.addMemberBtn.classList.remove('hidden');
                    } else {
                        isAdmin = false;
                        authStatusEl.innerHTML = 'Đã đăng nhập với vai trò **Cán bộ**';
                        uiElements.addPrecinctBtn.classList.add('hidden');
                        uiElements.addHouseholdBtn.classList.add('hidden');
                        uiElements.addMemberBtn.classList.add('hidden');
                    }
                    
                    setupPrecinctsListener();
                } else {
                    userId = null;
                    isAdmin = false;
                    authStatusEl.textContent = 'Đang chờ xác thực...';
                    loginButtons.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                }
            });

            // Đăng nhập với token được cung cấp hoặc ẩn danh
            (async () => {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            })();

        } catch (error) {
            console.error("Lỗi khi khởi tạo Firebase:", error);
            showModal("Lỗi", "Không thể kết nối đến hệ thống. Vui lòng thử lại sau.");
        }

        // --- Quản lý trạng thái giao diện và dữ liệu ---
        let currentPrecinctId = null;
        let currentPrecinctName = null;
        let currentHouseholdId = null;
        let currentHouseholdName = null;

        const uiElements = {
            mainContent: document.getElementById('main-content'),
            precinctSection: document.getElementById('precinct-list-section'),
            householdSection: document.getElementById('household-list-section'),
            memberSection: document.getElementById('member-list-section'),
            precinctsList: document.getElementById('precincts-list'),
            householdsList: document.getElementById('households-list'),
            membersList: document.getElementById('members-list'),
            householdListTitle: document.getElementById('household-list-title'),
            memberListTitle: document.getElementById('member-list-title'),
            homeLink: document.getElementById('home-link'),
            householdCrumb: document.getElementById('household-crumb'),
            memberCrumb: document.getElementById('member-crumb'),
            addPrecinctBtn: document.getElementById('add-precinct-btn'),
            addHouseholdBtn: document.getElementById('add-household-btn'),
            addMemberBtn: document.getElementById('add-member-btn')
        };
        
        // --- Danh sách 32 thôn, buôn từ tệp tin đã cung cấp ---
        const initialPrecincts = [
            "buôn alê gŏ", "buôn dhu", "buôn ea kjoh a", "buôn ea kjoh b", "buôn hně", "buôn hnĕ",
            "buôn klat a", "buôn klat b", "buôn klat c", "buôn kmiên", "buôn pheo", "buôn phieo",
            "buôn sĭng a", "buôn sing a", "buôn tring 4", "buôn tung krăk", "buôn tung krắk",
            "buôn trang", "buôn trăp", "t2b", "thôn 10", "thôn 1a", "thôn 1b", "thôn 2", "thôn 2a",
            "thôn 2b", "thôn 3", "thôn 5", "thôn 6", "thôn 6a", "thôn 6b", "thôn 7", "thôn 8",
            "thôn 9", "thôn đông xuân", "thôn ea kung", "thôn quyết thắng", "thôn tân hợp"
        ];

        // --- Firestore Listeners và Render UI ---

        async function initializePrecincts() {
            if (!isAdmin) return;
            const precinctsCollectionRef = collection(db, `artifacts/${appId}/public/data/precincts`);
            const snapshot = await getDocs(precinctsCollectionRef);
            if (snapshot.empty) {
                for (const precinctName of initialPrecincts) {
                    await addDoc(precinctsCollectionRef, {
                        name: precinctName,
                        creatorId: 'initial_setup',
                        createdAt: new Date().toISOString()
                    });
                }
            }
        }
        
        // Lắng nghe danh sách Thôn/Buôn
        function setupPrecinctsListener() {
            const precinctsCollection = `artifacts/${appId}/public/data/precincts`;
            onSnapshot(collection(db, precinctsCollection), (snapshot) => {
                const precincts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayPrecincts(precincts);
            }, (error) => {
                console.error("Lỗi khi lắng nghe thôn/buôn:", error);
                showModal("Lỗi", "Không thể tải danh sách thôn/buôn.");
            });
        }

        function displayPrecincts(precincts) {
            uiElements.precinctsList.innerHTML = '';
            if (precincts.length === 0) {
                uiElements.precinctsList.innerHTML = '<p class="text-center text-gray-500">Chưa có thôn/buôn nào.</p>';
            }
            precincts.forEach(p => {
                const item = document.createElement('div');
                item.className = 'bg-gray-50 rounded-lg p-4 shadow-sm flex items-center justify-between transition-colors duration-200 hover:bg-gray-100 cursor-pointer';
                item.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        <span class="text-lg font-medium">${p.name}</span>
                    </div>
                    ${isAdmin ? `<button class="delete-btn text-red-500 hover:text-red-700 transition-all duration-200" data-id="${p.id}" data-type="precinct">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>` : ''}
                `;
                item.addEventListener('click', () => showHouseholds(p.id, p.name));
                uiElements.precinctsList.appendChild(item);
            });
            setupDeleteListeners();
        }

        // Lắng nghe danh sách Hộ gia đình
        function setupHouseholdsListener() {
            const householdsCollection = `artifacts/${appId}/public/data/precincts/${currentPrecinctId}/households`;
            onSnapshot(collection(db, householdsCollection), (snapshot) => {
                const households = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayHouseholds(households);
            }, (error) => {
                console.error("Lỗi khi lắng nghe hộ gia đình:", error);
                showModal("Lỗi", "Không thể tải danh sách hộ gia đình.");
            });
        }
        
        function displayHouseholds(households) {
            uiElements.householdsList.innerHTML = '';
            if (households.length === 0) {
                uiElements.householdsList.innerHTML = '<p class="text-center text-gray-500">Chưa có hộ gia đình nào trong thôn này.</p>';
            }
            households.forEach(h => {
                const item = document.createElement('div');
                item.className = 'bg-gray-50 rounded-lg p-4 shadow-sm flex items-center justify-between transition-colors duration-200 hover:bg-gray-100 cursor-pointer';
                item.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2a2 2 0 012-2m14 0V9a2 2 0 00-2-2H7a2 2 0 00-2 2v2m14 0a2 2 0 01-2 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2a2 2 0 012-2m14 0V9a2 2 0 00-2-2H7a2 2 0 00-2 2v2m14 0a2 2 0 01-2 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2a2 2 0 012-2m14 0V9a2 2 0 00-2-2H7a2 2 0 00-2 2v2" />
                        </svg>
                        <span class="text-lg font-medium">${h.name}</span>
                    </div>
                    ${isAdmin ? `<button class="delete-btn text-red-500 hover:text-red-700 transition-all duration-200" data-id="${h.id}" data-type="household">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>` : ''}
                `;
                item.addEventListener('click', () => showMembers(h.id, h.name));
                uiElements.householdsList.appendChild(item);
            });
            setupDeleteListeners();
        }

        // Lắng nghe danh sách Thành viên
        function setupMembersListener() {
            const membersCollection = `artifacts/${appId}/public/data/precincts/${currentPrecinctId}/households/${currentHouseholdId}/members`;
            onSnapshot(collection(db, membersCollection), (snapshot) => {
                const members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayMembers(members);
            }, (error) => {
                console.error("Lỗi khi lắng nghe thành viên:", error);
                showModal("Lỗi", "Không thể tải danh sách thành viên.");
            });
        }

        function displayMembers(members) {
            uiElements.membersList.innerHTML = '';
            if (members.length === 0) {
                uiElements.membersList.innerHTML = '<p class="text-center text-gray-500">Chưa có thành viên nào trong hộ này.</p>';
            }
            members.forEach(m => {
                const item = document.createElement('div');
                item.className = 'bg-gray-50 rounded-lg p-4 shadow-sm flex items-center justify-between';
                item.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-6 0H6"/>
                        </svg>
                        <div>
                            <span class="text-lg font-medium">${m.name}</span>
                            <p class="text-sm text-gray-600">CCCD: ${m.cccd}</p>
                        </div>
                    </div>
                    ${isAdmin ? `<button class="delete-btn text-red-500 hover:text-red-700 transition-all duration-200" data-id="${m.id}" data-type="member">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>` : ''}
                `;
                item.addEventListener('click', () => {
                    // Do nothing, just to stop propagation
                });
                uiElements.membersList.appendChild(item);
            });
            setupDeleteListeners();
        }

        // --- Chuyển đổi giao diện ---
        function showPrecincts() {
            uiElements.precinctSection.classList.remove('hidden');
            uiElements.householdSection.classList.add('hidden');
            uiElements.memberSection.classList.add('hidden');
            uiElements.householdCrumb.classList.add('hidden');
            uiElements.memberCrumb.classList.add('hidden');
            currentPrecinctId = null;
            currentPrecinctName = null;
            currentHouseholdId = null;
            currentHouseholdName = null;
        }

        function showHouseholds(precinctId, precinctName) {
            uiElements.precinctSection.classList.add('hidden');
            uiElements.householdSection.classList.remove('hidden');
            uiElements.memberSection.classList.add('hidden');
            
            uiElements.householdListTitle.textContent = `Hộ gia đình tại Thôn ${precinctName}`;
            uiElements.householdCrumb.classList.remove('hidden');
            uiElements.householdCrumb.querySelector('a').textContent = precinctName;
            uiElements.memberCrumb.classList.add('hidden');
            
            currentPrecinctId = precinctId;
            currentPrecinctName = precinctName;
            currentHouseholdId = null;
            currentHouseholdName = null;
            
            setupHouseholdsListener();
        }

        function showMembers(householdId, householdName) {
            uiElements.precinctSection.classList.add('hidden');
            uiElements.householdSection.classList.add('hidden');
            uiElements.memberSection.classList.remove('hidden');
            
            uiElements.memberListTitle.textContent = `Thành viên Hộ ${householdName}`;
            uiElements.memberCrumb.classList.remove('hidden');
            
            currentHouseholdId = householdId;
            currentHouseholdName = householdName;
            
            setupMembersListener();
        }
        
        // --- Xử lý Đăng nhập, Thêm và Xóa ---
        document.getElementById('admin-login-btn').addEventListener('click', async () => {
            if (!auth) { showModal("Lỗi", "Hệ thống xác thực chưa sẵn sàng."); return; }
            await signInWithCustomToken(auth, ADMIN_ID);
        });
        
        document.getElementById('cadre-login-btn').addEventListener('click', async () => {
            if (!auth) { showModal("Lỗi", "Hệ thống xác thực chưa sẵn sàng."); return; }
            await signInAnonymously(auth);
        });

        document.getElementById('home-link').addEventListener('click', (e) => {
            e.preventDefault();
            showPrecincts();
        });

        document.querySelector('.household-crumb-link').addEventListener('click', (e) => {
            e.preventDefault();
            showHouseholds(currentPrecinctId, currentPrecinctName);
        });
        
        // Mở modal thêm Thôn/Buôn
        uiElements.addPrecinctBtn.addEventListener('click', () => {
            if (!isAdmin) { showModal("Lỗi", "Bạn không có quyền thêm thôn/buôn."); return; }
            showAddForm("Thêm Thôn/Buôn", (name) => {
                addDoc(collection(db, `artifacts/${appId}/public/data/precincts`), { name, creatorId: userId, createdAt: new Date().toISOString() })
                    .then(() => showModal("Thành công", "Đã thêm thôn/buôn thành công."))
                    .catch(error => { console.error("Lỗi thêm thôn/buôn:", error); showModal("Lỗi", "Không thể thêm thôn/buôn."); });
            });
        });

        // Mở modal thêm Hộ gia đình
        uiElements.addHouseholdBtn.addEventListener('click', () => {
            if (!isAdmin) { showModal("Lỗi", "Bạn không có quyền thêm hộ gia đình."); return; }
            showAddForm("Thêm Hộ gia đình", (name) => {
                const householdsCollection = `artifacts/${appId}/public/data/precincts/${currentPrecinctId}/households`;
                addDoc(collection(db, householdsCollection), { name, creatorId: userId, createdAt: new Date().toISOString() })
                    .then(() => showModal("Thành công", "Đã thêm hộ gia đình thành công."))
                    .catch(error => { console.error("Lỗi thêm hộ gia đình:", error); showModal("Lỗi", "Không thể thêm hộ gia đình."); });
            });
        });

        // Mở modal thêm Thành viên
        uiElements.addMemberBtn.addEventListener('click', () => {
            if (!isAdmin) { showModal("Lỗi", "Bạn không có quyền thêm thành viên."); return; }
            showAddMemberForm();
        });

        function showAddForm(title, onSubmit) {
            const modalContent = document.getElementById('modal-content-area');
            modalContent.innerHTML = `
                <form id="add-item-form" class="space-y-4">
                    <input type="text" id="item-name" placeholder="Nhập tên" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-200">
                        Thêm
                    </button>
                </form>
            `;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal').style.display = 'flex';
            
            document.getElementById('add-item-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('item-name').value;
                onSubmit(name);
                document.getElementById('modal').style.display = 'none';
            });
        }
        
        function showAddMemberForm() {
            const modalContent = document.getElementById('modal-content-area');
            modalContent.innerHTML = `
                <form id="add-member-item-form" class="space-y-4">
                    <input type="text" id="member-name" placeholder="Nhập tên thành viên" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    <input type="text" id="member-cccd" placeholder="Nhập số căn cước" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-200">
                        Thêm Thành viên
                    </button>
                </form>
            `;
            document.getElementById('modal-title').textContent = "Thêm Thành viên mới";
            document.getElementById('modal').style.display = 'flex';
            
            document.getElementById('add-member-item-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('member-name').value;
                const cccd = document.getElementById('member-cccd').value;
                if (!name || !cccd) { showModal("Lỗi", "Vui lòng điền đầy đủ thông tin."); return; }
                
                const membersCollection = `artifacts/${appId}/public/data/precincts/${currentPrecinctId}/households/${currentHouseholdId}/members`;
                addDoc(collection(db, membersCollection), { name, cccd, creatorId: userId, createdAt: new Date().toISOString() })
                    .then(() => showModal("Thành công", "Đã thêm thành viên thành công."))
                    .catch(error => { console.error("Lỗi thêm thành viên:", error); showModal("Lỗi", "Không thể thêm thành viên."); });
                document.getElementById('modal').style.display = 'none';
            });
        }
        
        function setupDeleteListeners() {
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    event.stopPropagation(); // Ngăn sự kiện click lan truyền lên phần tử cha
                    const idToDelete = event.currentTarget.getAttribute('data-id');
                    const type = event.currentTarget.getAttribute('data-type');
                    handleDelete(idToDelete, type);
                });
            });
        }
        
        async function handleDelete(idToDelete, type) {
            if (!isAdmin) { showModal("Lỗi", "Bạn không có quyền xóa mục này."); return; }
            
            let collectionPath;
            if (type === 'precinct') {
                collectionPath = `artifacts/${appId}/public/data/precincts`;
            } else if (type === 'household') {
                collectionPath = `artifacts/${appId}/public/data/precincts/${currentPrecinctId}/households`;
            } else if (type === 'member') {
                collectionPath = `artifacts/${appId}/public/data/precincts/${currentPrecinctId}/households/${currentHouseholdId}/members`;
            }
            
            try {
                await deleteDoc(doc(db, collectionPath, idToDelete));
                showModal("Thành công", `Đã xóa ${type} thành công.`);
            } catch (error) {
                console.error("Lỗi khi xóa:", error);
                showModal("Lỗi", `Không thể xóa ${type}. Vui lòng thử lại.`);
            }
        }

        // --- Modal Control ---
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        
        function showModal(title, message) {
            modalTitle.textContent = title;
            const contentArea = document.getElementById('modal-content-area');
            contentArea.innerHTML = `<p class="text-gray-700 mb-6">${message}</p>
                                     <button id="modal-close-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-all duration-200">Đóng</button>`;
            modal.style.display = 'flex';
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
        
        // Khởi tạo các thôn/buôn khi ứng dụng khởi chạy
        window.onload = initializePrecincts;
        
    </script>
</body>
</html>
